var http = require('http');
var url = require('url');
var request = require('request');
var Service, Characteristic;
var currentSpeed = 0;

module.exports = function (homebridge) {
  Service = homebridge.hap.Service;
  Characteristic = homebridge.hap.Characteristic;

  homebridge.registerAccessory("homebridge-itho-cve-eco-rft", "IthoCVE_ECO_RFT_Ventilation_Accessory", mySwitch);
};

function mySwitch(log, config) {
  this.log = log;
  this.url = config['url'];
}

mySwitch.prototype = {
  getServices: function () {
    this.informationService = new Service.AccessoryInformation();
    this.informationService
      .setCharacteristic(Characteristic.Manufacturer, "Itho CVE")
      .setCharacteristic(Characteristic.Model, "IthoCVE ECO RFT Ventilatio")
      .setCharacteristic(Characteristic.SerialNumber, "123-456-789");

    this.fanService = new Service.Fanv2("Ventilation");
    this.fanService
      .getCharacteristic(Characteristic.Active)
      .on('get', this.getActive.bind(this))
      .on('set', this.setActive.bind(this));
    this.fanService.getCharacteristic(Characteristic.RotationSpeed)
      .setProps({
        minValue: 0,
        maxValue: 2,
        minStep: 1
      })
      .on('get', this.getSpeed.bind(this))
      .on('set', this.setSpeed.bind(this));

    this.timerService = new Service.Switch();
    this.timerService.setCharacteristic(Characteristic.Name, 'Ventilate 10 min');
    this.timerService.getCharacteristic(Characteristic.On)
      .on('get', this.getTimer.bind(this))
      .on('set', this.setTimer.bind(this));

    return [
      this.informationService,
      this.fanService,
      this.timerService,
      // this.humidityService
    ];
  },

  getTimer: function(next) {
    console.log('get timer');
    next(null, 0);
  },

  setTimer: function(value, next) {
    console.log('set timer', value);
    this.pressButton('timer', next);
  },

  getHumidity: function(next) {
    next(null, 2);
  },

  getSpeed: function(next) {
    console.log('current speed', currentSpeed);
    next(null, currentSpeed);
  },

  setSpeed: function(value, next) {
    if (currentSpeed === value) {
      console.log('already set speed', value);
      return next(null);
    }
    console.log('set speed', value);
    const speedMap = {
      0: 'low',
      1: 'medium',
      2: 'high'
    };
    currentSpeed = value;
    this.pressButton(speedMap[value], next);
  },

  getActive: function (next) {
    console.log('get active');
    this.getSpeed(next);
  },

  setActive: function (value, next) {
    console.log('set active', value);
    const speedMap = {
      0: 0,
      1: 1,
    };
    this.setSpeed(speedMap[value], next);
  },

  pressButton: function(button, next, value) {
    const me = this;
    request({ url: me.url + '/press?button=' + button },
      function (error, response) {
        if (error) {
          me.log('STATUS: ' + response.statusCode);
          me.log(error.message);
          return next(error);
        }
        return next(null);
      });
  }
};
